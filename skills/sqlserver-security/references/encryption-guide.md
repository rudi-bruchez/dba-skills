# SQL Server Encryption Guide

---

## Encryption at Rest: Transparent Data Encryption (TDE)

TDE encrypts data files, log files, and backup files at rest. Encryption and decryption happen at the page level, transparently to applications.

### TDE Setup (Step-by-Step)

**Step 1 — Create master key in master database**
```sql
USE master;
-- The master key encrypts the TDE certificate's private key
CREATE MASTER KEY ENCRYPTION BY PASSWORD = 'StrongMasterKeyPassword2024!';

-- Verify
SELECT name, create_date FROM sys.symmetric_keys WHERE name = '##MS_DatabaseMasterKey##';
```

**Step 2 — Create TDE certificate**
```sql
USE master;
CREATE CERTIFICATE TDECert
WITH SUBJECT = 'TDE Certificate for ProductionDB',
     EXPIRY_DATE = '2034-12-31';  -- Optional; certificates do not expire by default

-- Verify
SELECT name, subject, expiry_date, start_date FROM sys.certificates WHERE name = 'TDECert';
```

**Step 3 — Back up the certificate (MANDATORY before enabling TDE)**

Losing the certificate means permanent, irrecoverable data loss. Store the backup off-server in a secure vault.

```sql
BACKUP CERTIFICATE TDECert
TO FILE = 'D:\CertBackups\TDECert.cer'
WITH PRIVATE KEY (
    FILE = 'D:\CertBackups\TDECert.pvk',
    ENCRYPTION BY PASSWORD = 'CertPrivateKeyPassword2024!'
);
-- Store BOTH files AND the private key password in a password manager or vault
-- The .cer file alone is insufficient — the .pvk file is required for restore
```

**Step 4 — Create database encryption key**
```sql
USE [ProductionDB];
CREATE DATABASE ENCRYPTION KEY
WITH ALGORITHM = AES_256
ENCRYPTION BY SERVER CERTIFICATE TDECert;
```

**Step 5 — Enable encryption**
```sql
ALTER DATABASE [ProductionDB] SET ENCRYPTION ON;
```

**Step 6 — Monitor encryption progress**
```sql
SELECT
    DB_NAME(database_id)  AS database_name,
    encryption_state,
    CASE encryption_state
        WHEN 0 THEN 'No database encryption key present'
        WHEN 1 THEN 'Unencrypted'
        WHEN 2 THEN 'Encryption in progress'
        WHEN 3 THEN 'Encrypted'
        WHEN 4 THEN 'Key change in progress'
        WHEN 5 THEN 'Decryption in progress'
    END AS encryption_state_desc,
    percent_complete,
    encryptor_thumbprint
FROM sys.dm_database_encryption_keys;
-- Wait until encryption_state = 3 before considering setup complete
-- Large databases may take hours to encrypt
```

### TDE Key Rotation

Rotate the TDE certificate annually or when a security event requires it.

```sql
-- Create a new certificate
USE master;
CREATE CERTIFICATE TDECert_2025
WITH SUBJECT = 'TDE Certificate 2025 Rotation';

-- Back up the new certificate (MANDATORY)
BACKUP CERTIFICATE TDECert_2025
TO FILE = 'D:\CertBackups\TDECert_2025.cer'
WITH PRIVATE KEY (
    FILE = 'D:\CertBackups\TDECert_2025.pvk',
    ENCRYPTION BY PASSWORD = 'NewCertPassword2025!'
);

-- Rotate the DEK to use the new certificate
USE [ProductionDB];
ALTER DATABASE ENCRYPTION KEY
REGENERATE WITH ALGORITHM = AES_256
ENCRYPTION BY SERVER CERTIFICATE TDECert_2025;

-- Monitor the rotation
SELECT DB_NAME(database_id), encryption_state_desc, percent_complete
FROM sys.dm_database_encryption_keys;
-- encryption_state = 4 (Key change in progress) then 3 (Encrypted)
```

### Restoring a TDE Database to Another Server

The certificate must be on the destination server before the restore.

```sql
-- On destination server: restore the certificate from backup
USE master;
CREATE MASTER KEY ENCRYPTION BY PASSWORD = 'DestinationMasterKey!';

CREATE CERTIFICATE TDECert
FROM FILE = 'D:\CertBackups\TDECert.cer'
WITH PRIVATE KEY (
    FILE = 'D:\CertBackups\TDECert.pvk',
    DECRYPTION BY PASSWORD = 'CertPrivateKeyPassword2024!'
);

-- Now restore the database normally
RESTORE DATABASE [ProductionDB]
FROM DISK = N'D:\Backups\ProductionDB_Full.bak'
WITH RECOVERY, REPLACE, STATS = 10;
```

---

## Column-Level Encryption: Always Encrypted

Always Encrypted encrypts specific columns at the client driver level. The SQL Server engine never sees plaintext data. Keys are stored outside SQL Server (Windows Certificate Store, Azure Key Vault, Hardware Security Module).

### Setup Overview (Wizard Recommended for Initial Setup)

```sql
-- Step 1: Create column master key metadata (key stored externally)
CREATE COLUMN MASTER KEY [CMK_AE]
WITH (
    KEY_STORE_PROVIDER_NAME = N'MSSQL_CERTIFICATE_STORE',
    KEY_PATH = N'CurrentUser/My/CERTIFICATE_THUMBPRINT'
);

-- Step 2: Create column encryption key metadata
-- The encrypted value is generated by SSMS/PowerShell using the CMK
CREATE COLUMN ENCRYPTION KEY [CEK_AE]
WITH VALUES (
    COLUMN_MASTER_KEY = [CMK_AE],
    ALGORITHM = 'RSA_OAEP',
    ENCRYPTED_VALUE = 0x01700...  -- Generated value
);

-- Step 3: Create or alter table with encrypted columns
CREATE TABLE dbo.PatientData (
    patient_id   INT PRIMARY KEY,
    name         NVARCHAR(200) NOT NULL,
    ssn          CHAR(11) ENCRYPTED WITH (
                     ENCRYPTION_TYPE = DETERMINISTIC,  -- Allows equality search
                     ALGORITHM = 'AEAD_AES_256_CBC_HMAC_SHA_256',
                     COLUMN_ENCRYPTION_KEY = CEK_AE) NOT NULL,
    medical_notes NVARCHAR(MAX) ENCRYPTED WITH (
                     ENCRYPTION_TYPE = RANDOMIZED,     -- No equality search; more secure
                     ALGORITHM = 'AEAD_AES_256_CBC_HMAC_SHA_256',
                     COLUMN_ENCRYPTION_KEY = CEK_AE) NULL
);
```

**Encryption types:**
- `DETERMINISTIC` — same plaintext always produces same ciphertext; allows `=` comparisons and indexes.
- `RANDOMIZED` — same plaintext produces different ciphertext each time; more secure but no equality search.

**Connection string requirement:** `Column Encryption Setting=Enabled` must be in the ADO.NET/ODBC connection string for the client driver to transparently encrypt/decrypt.

---

## Transparent Connection Encryption (TLS/SSL)

TLS encrypts all data in transit between clients and SQL Server.

### Configure TLS in SQL Server Configuration Manager

1. Install a valid TLS certificate on the SQL Server (from internal CA or public CA).
2. Open **SQL Server Configuration Manager** → **SQL Server Network Configuration** → **Protocols for MSSQLSERVER** → **Properties**.
3. Set **Force Encryption = Yes** to require all connections to be encrypted.
4. Restart SQL Server service.

**Verify encryption on active connections:**
```sql
SELECT session_id, encrypt_option, net_transport, client_net_address, auth_scheme
FROM sys.dm_exec_connections
ORDER BY encrypt_option;
-- encrypt_option = TRUE = encrypted; FALSE = not encrypted
-- After enabling Force Encryption, all connections should show TRUE
```

---

## Symmetric Key Encryption (Cell-Level)

For encrypting specific values without Always Encrypted infrastructure.

```sql
-- Create a symmetric key
USE [YourDatabase];
CREATE SYMMETRIC KEY DataKey_AES256
WITH ALGORITHM = AES_256
ENCRYPTION BY PASSWORD = 'SymKeyPassword!';

-- Encrypt data
OPEN SYMMETRIC KEY DataKey_AES256 DECRYPTION BY PASSWORD = 'SymKeyPassword!';

UPDATE dbo.SensitiveData
SET encrypted_ssn = EncryptByKey(Key_GUID('DataKey_AES256'), plain_ssn);

CLOSE SYMMETRIC KEY DataKey_AES256;

-- Decrypt data
OPEN SYMMETRIC KEY DataKey_AES256 DECRYPTION BY PASSWORD = 'SymKeyPassword!';

SELECT
    record_id,
    CONVERT(NVARCHAR(20), DecryptByKey(encrypted_ssn)) AS decrypted_ssn
FROM dbo.SensitiveData;

CLOSE SYMMETRIC KEY DataKey_AES256;
```

**Limitation:** The decryption key/password must be available at query time — not suitable when SQL Server itself must not see plaintext (use Always Encrypted for that).

---

## Backup Encryption

Encrypt backup files to protect data at rest on backup media and during transport.

```sql
-- Prerequisites: master key + certificate in master database (create if not exists)
USE master;
IF NOT EXISTS (SELECT 1 FROM sys.symmetric_keys WHERE name = '##MS_DatabaseMasterKey##')
    CREATE MASTER KEY ENCRYPTION BY PASSWORD = 'MasterKeyPassword!';

IF NOT EXISTS (SELECT 1 FROM sys.certificates WHERE name = 'BackupEncryptCert')
BEGIN
    CREATE CERTIFICATE BackupEncryptCert
    WITH SUBJECT = 'Database Backup Encryption';
    -- IMPORTANT: Back up this certificate!
    BACKUP CERTIFICATE BackupEncryptCert
    TO FILE = 'D:\CertBackups\BackupEncryptCert.cer'
    WITH PRIVATE KEY (
        FILE = 'D:\CertBackups\BackupEncryptCert.pvk',
        ENCRYPTION BY PASSWORD = 'CertPvkPassword!'
    );
END;

-- Encrypted backup
BACKUP DATABASE [YourDB]
TO DISK = N'D:\Backups\YourDB_Encrypted.bak'
WITH
    COMPRESSION,
    ENCRYPTION (ALGORITHM = AES_256, SERVER CERTIFICATE = BackupEncryptCert),
    STATS = 10;

-- To restore an encrypted backup, the certificate must exist on the target server
-- (same process as TDE certificate restore above)
```
